<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Panel SCADA & Asistente IA EVA</title>
    
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        :root[data-theme="dark"] {
            --bg-base: #050a10; --bg-panel: rgba(10, 25, 40, 0.85);
            --text-main: #00e5ff; --text-dim: #4da8da;
            --accent-amber: #ffb300; --accent-crimson: #ff1744; 
            --accent-green: #00ff00;
            --border-color: #008b8b; --text-white: #ffffff;
            --grid-color: rgba(0, 229, 255, 0.05);
        }

        :root[data-theme="light"] {
            --bg-base: #e0e6ed; --bg-panel: rgba(240, 245, 250, 0.95);
            --text-main: #005f73; --text-dim: #0a9396;
            --accent-amber: #ca6702; --accent-crimson: #ae2012; 
            --accent-green: #10b981;
            --border-color: #94d2bd; --text-white: #001219;
            --grid-color: rgba(0, 95, 115, 0.05);
        }

        * { box-sizing: border-box; transition: background-color 0.3s, color 0.3s; }

        body {
            background-color: var(--bg-base); color: var(--text-main);
            font-family: 'Consolas', 'Courier New', monospace;
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            min-height: 100vh; line-height: 1.6; overflow-x: hidden;
            background-image: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* OVERLAY DE INICIO */
        #init-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000000; z-index: 99999;
            display: flex; justify-content: center; align-items: center; flex-direction: column; cursor: pointer;
        }
        .blinking-text {
            color: var(--text-main); font-size: 1.5rem; font-weight: bold;
            animation: blink 1.5s infinite; text-align: center;
            padding: 20px; border: 2px dashed var(--text-main); box-shadow: 0 0 20px rgba(0, 229, 255, 0.3);
        }

        .crt-off { animation: turn-off 0.6s cubic-bezier(0.23, 1, 0.32, 1) forwards; pointer-events: none; background-color: #000 !important; }
        @keyframes turn-off { 0% { transform: scale(1, 1); filter: brightness(1); } 60% { transform: scale(1, 0.005); filter: brightness(10); } 100% { transform: scale(0, 0.0001); filter: brightness(0); } }

        .ai-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; opacity: 0.05; font-size: 1.1rem; color: var(--text-dim); pointer-events: none; padding: 20px; line-height: 4; user-select: none; }

        .top-controls { position: fixed; top: 15px; left: 20px; display: flex; gap: 10px; z-index: 200; }
        .top-btn { background: var(--bg-panel); border: 1px solid var(--border-color); color: var(--text-main); padding: 5px 15px; font-size: 0.85rem; cursor: pointer; font-weight: bold; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px); }
        .top-btn:hover { background: var(--text-main); color: var(--bg-base); }

        .main-layout { display: flex; gap: 30px; max-width: 1200px; width: 100%; justify-content: center; align-items: flex-start; margin-top: 20px; margin-bottom: 10px; z-index: 10; position: relative; }

        /* ====== DISEÑO DEL ROBOT EVA (SVG) ====== */
        .assistant-panel {
            width: 320px; flex-shrink: 0;
            background: linear-gradient(180deg, rgba(0, 229, 255, 0.05) 0%, rgba(10, 25, 40, 0.8) 100%);
            border: 1px solid var(--border-color); border-top: 4px solid var(--text-white);
            padding: 20px; display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 0 30px rgba(0, 229, 255, 0.1); position: sticky; top: 60px;
            border-radius: 20px; z-index: 50;
        }

        #eve-container {
            width: 200px; height: 250px;
            animation: float 4s ease-in-out infinite;
            filter: drop-shadow(0 15px 10px rgba(0,0,0,0.5));
            transition: all 0.3s;
        }

        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-15px); } }

        /* --- Ojos de EVA --- */
        .eve-eyes { fill: #00e5ff; transition: fill 0.3s, filter 0.3s; filter: drop-shadow(0 0 8px #00e5ff); }
        
        /* Animación Hablando */
        .speaking .eve-eyes {
            fill: #ffffff; filter: drop-shadow(0 0 15px #00e5ff);
            animation: speak-eyes 0.3s infinite alternate;
        }
        @keyframes speak-eyes { 0% { transform: scaleY(1); } 100% { transform: scaleY(0.6) translateY(10px); } }

        /* --- ESTADOS DE RESPUESTA (MOVIMIENTO DE CABEZA Y OJOS) --- */
        #eve-head { transform-origin: 100px 90px; } /* Eje de rotación en el cuello */

        /* Acierto (Asiente / Verde) */
        .state-correct .eve-eyes { fill: var(--accent-green) !important; filter: drop-shadow(0 0 20px var(--accent-green)) !important; }
        .state-correct #eve-head { animation: nod-head 0.6s ease-in-out 2; }
        
        @keyframes nod-head {
            0%, 100% { transform: translateY(0) rotateX(0deg); }
            50% { transform: translateY(12px) rotate(3deg); }
        }

        /* Fallo (Niega / Rojo) */
        .state-wrong .eve-eyes { fill: var(--accent-crimson) !important; filter: drop-shadow(0 0 20px var(--accent-crimson)) !important; }
        .state-wrong #eve-head { animation: shake-head 0.4s ease-in-out 2; }

        @keyframes shake-head {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            25% { transform: translateX(-10px) rotate(-8deg); }
            75% { transform: translateX(10px) rotate(8deg); }
        }

        .assistant-status { margin-top: 15px; font-weight: bold; font-size: 0.9rem; color: var(--text-dim); width: 100%; text-align: center; border-top: 1px dashed var(--border-color); padding-top: 10px; letter-spacing: 1px; }
        .assistant-status.speaking { color: var(--text-white); text-shadow: 0 0 8px var(--text-main); }

        /* ====== TERMINAL SCADA ====== */
        #terminal-container { width: 100%; flex-grow: 1; display: flex; flex-direction: column; gap: 15px; }
        .scada-box { background: var(--bg-panel); border-top: 4px solid var(--text-main); border-bottom: 4px solid var(--text-main); border-left: 1px solid var(--border-color); border-right: 1px solid var(--border-color); padding: 30px; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }

        /* FIRMA DEL CREADOR (ABAJO) */
        .creator-signature {
            text-align: center; font-weight: bold; font-size: 0.85rem; color: var(--accent-amber);
            padding: 15px; border: 1px dashed var(--accent-amber); background: rgba(255, 179, 0, 0.05);
            text-transform: uppercase; letter-spacing: 2px;
        }
        .creator-contact { font-size: 0.9rem; color: var(--text-white); display: block; margin-top: 5px; }

        .greeble { position: absolute; font-size: 0.65rem; color: var(--text-dim); font-weight: bold; letter-spacing: 1px; }
        .g-top-left { top: 5px; left: 10px; } .g-top-right { top: 5px; right: 10px; cursor: crosshair; } .g-bottom-right { bottom: 5px; right: 10px; }

        h1, h2, h3 { color: var(--text-white); margin-top: 0; }
        .amber-text { color: var(--accent-amber); } .crimson-text { color: var(--accent-crimson); } .success-text { color: var(--accent-green); }

        #sidebar { position: fixed; right: -100%; top: 60px; width: 350px; height: calc(100% - 80px); background: var(--bg-panel); border: 1px solid var(--border-color); border-right: none; padding: 20px; z-index: 150; transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1); overflow-y: auto; box-shadow: -5px 0 15px rgba(0,0,0,0.3); border-left: 3px solid var(--accent-amber); }
        #sidebar.open { right: 0; }

        .btn-industrial { background: transparent; color: var(--text-main); border: 1px solid var(--border-color); padding: 12px 15px; font-family: inherit; font-size: 1rem; cursor: pointer; width: 100%; text-align: left; margin-bottom: 10px; border-left: 4px solid var(--text-main); transition: all 0.2s; }
        .btn-industrial:hover:not(:disabled) { background: rgba(0, 229, 255, 0.1); padding-left: 20px; }
        .btn-abort { border-color: var(--accent-crimson); color: var(--accent-crimson); border-left-color: var(--accent-crimson); text-align: center; margin-top: 20px; }
        .btn-abort:hover { background: rgba(255, 23, 68, 0.1); color: var(--text-white); }
        .btn-download { border-color: var(--accent-amber); color: var(--accent-amber); border-left-color: var(--accent-amber); text-align: center; font-weight: bold; }

        .hud { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px; font-size: 0.9rem; font-weight: bold; }

        .options-grid { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .option-btn { display: flex; align-items: flex-start; gap: 10px; border: 1px solid var(--border-color); padding: 15px; cursor: pointer; background: transparent; color: var(--text-white); font-family: inherit; text-align: left; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px); transition: all 0.2s; word-wrap: break-word; }
        .option-btn.disabled { opacity: 0.5; pointer-events: none; }
        .option-btn.correct { background: rgba(0, 255, 0, 0.15) !important; border-color: var(--accent-green) !important; color: var(--accent-green) !important; opacity: 1 !important; }
        .option-btn.wrong { background: rgba(255, 23, 68, 0.1) !important; border-color: var(--accent-crimson) !important; color: var(--accent-crimson) !important; opacity: 1 !important; text-decoration: line-through; }
        .option-letter { font-weight: bold; color: var(--text-main); padding-right: 10px; min-width: 30px; }

        #feedback-area { margin-top: 20px; padding: 20px; border: 1px solid var(--accent-amber); display: none; background: rgba(255, 179, 0, 0.05); color: var(--text-white); border-left: 5px solid var(--accent-amber); animation: fadeIn 0.3s; }
        #btn-next { display: none; margin-top: 20px; text-align: center; font-weight: bold; border-style: dashed; }
        .cursor { display: inline-block; width: 10px; height: 1.2em; background-color: var(--text-main); vertical-align: bottom; animation: blink 1s infinite; }
        .hidden { display: none !important; }
        
        @keyframes blink { 50% { opacity: 0; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ADAPTACIÓN MÓVIL (100% Responsiva) */
        @media (max-width: 900px) {
            body { padding: 10px; }
            .main-layout { flex-direction: column; align-items: center; margin-top: 40px; }
            /* EVA se queda pegada arriba en movil */
            .assistant-panel { 
                width: 100%; top: 45px; position: sticky; z-index: 100;
                flex-direction: row; justify-content: space-between; padding: 10px 20px; 
                margin-bottom: 10px; background: var(--bg-panel); border-radius: 10px;
                backdrop-filter: blur(10px); box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            }
            #eve-container { width: 60px; height: 75px; animation: none; filter: none; }
            .assistant-status { margin-top: 0; border-top: none; border-left: 1px dashed var(--border-color); padding-left: 15px; display: flex; align-items: center; font-size: 0.8rem; width: auto; flex-grow: 1;}
            
            #terminal-container { padding: 0; margin-top: 5px; width: 100%; }
            .scada-box { padding: 20px 15px; }
            .top-controls { background: var(--bg-base); width: 100%; top: 0; left: 0; padding: 10px; justify-content: space-around; border-bottom: 1px solid var(--border-color); }
            
            #sidebar { width: 90%; right: -100%; top: 50px; height: calc(100% - 50px);}
            .hud { flex-direction: column; align-items: flex-start; gap: 5px; }
            .math-container { font-size: 0.9rem; overflow-x: auto; }
            .creator-signature { font-size: 0.75rem; margin-top: 20px; }
        }
    </style>
</head>
<body>

    <div id="init-overlay" onclick="bootSystem()">
        <div class="blinking-text">[ INICIAR SISTEMA IA Y SCADA ]</div>
        <p style="color:var(--text-dim); margin-top:20px; text-align: center;">*Autorización de Hardware Requerida*</p>
    </div>

    <div class="ai-bg">
        \[ \sigma_x = \sqrt{\frac{1}{N-1}\sum (x_i - \bar{x})^2} \quad | \quad V = \iiint_D dx\,dy\,dz \]
        <br><br><br>
        \[ E = | V_{med} - V_{real} | \quad | \quad e_{rel} = \frac{E}{V_{med}} \]
    </div>

    <div class="top-controls">
        <button class="top-btn" onclick="toggleTheme()">[ TEMA ]</button>
        <button class="top-btn" onclick="toggleSidebar()" style="color: var(--accent-amber); border-color: var(--accent-amber);">[ DB_APUNTES ]</button>
    </div>

    <div id="sidebar">
        <button onclick="toggleSidebar()" style="background:none; color:var(--accent-crimson); border:none; width:100%; text-align:right; cursor:pointer; font-weight:bold;">[ CERRAR X ]</button>
        <h3 class="amber-text">[ REPOSITORIO LOCAL ]</h3>
        <p><b>> Cifras Significativas:</b> Ceros a la izquierda no cuentan. Ceros a la derecha SÍ cuentan.</p>
        <p><b>> Suma/Resta:</b> Se suman los Errores Absolutos. Resultado se corta con decimales del menos preciso.</p>
        <p><b>> Multiplicación/División:</b> Se suman los Errores Relativos ($e$).</p>
        <p><b>> Regla del Jefe:</b> Error Absoluto a 1 (o 2) cifras significativas. Valor central acata esa posición.</p>
        <p><b>> Exponentes:</b> $e_{Area} = 2 \cdot e_{radio}$.</p>
    </div>

    <div class="main-layout">
        
        <div class="assistant-panel" id="assistant-box">
            <div id="eve-container">
                <svg viewBox="0 0 200 250" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <radialGradient id="bodyGlow" cx="50%" cy="50%" r="50%">
                            <stop offset="80%" stop-color="#ffffff" />
                            <stop offset="100%" stop-color="#cccccc" />
                        </radialGradient>
                    </defs>
                    <path d="M 40,110 C 40,240 160,240 160,110 C 160,50 40,50 40,110 Z" fill="url(#bodyGlow)"/>
                    
                    <g id="eve-head">
                        <path d="M 45,65 C 45,10 155,10 155,65 C 155,100 45,100 45,65 Z" fill="#ffffff" />
                        <path d="M 52,62 C 52,25 148,25 148,62 C 148,90 52,90 52,62 Z" fill="#080c11" />
                        <g class="eve-eyes">
                            <path d="M 68,58 Q 80,48 92,58 Q 80,62 68,58 Z" />
                            <path d="M 108,58 Q 120,48 132,58 Q 120,62 108,58 Z" />
                        </g>
                    </g>
                    
                    <path d="M 30,105 C 15,145 25,185 35,185 C 42,185 45,145 42,105 Z" fill="#ffffff" />
                    <path d="M 170,105 C 185,145 175,185 165,185 C 158,185 155,145 158,105 Z" fill="#ffffff" />
                </svg>
            </div>
            <div class="assistant-status" id="eve-status">SISTEMA APAGADO</div>
        </div>

        <div id="terminal-container">
            <div class="scada-box">
                <div class="greeble g-top-left">[SYS_RDY]</div>
                <div class="greeble g-top-right" onclick="triggerEasterEgg()" title="Versión">SCADA_V.12</div>
                <div class="greeble g-bottom-right">[MOD-TEORIA-ERRORES]</div>
                
                <div id="screen-menu">
                    <h3 id="menu-title" style="color: var(--text-main); font-weight: normal; font-size: 1rem;"></h3>
                    <div id="menu-options" class="hidden">
                        <button class="btn-industrial" onclick="startModule('conceptos')">>> [MÓDULO 1] CONCEPTUAL (10 Preguntas)</button>
                        <button class="btn-industrial" onclick="startModule('ejercicios')">>> [MÓDULO 2] CÁLCULO (5 Ejercicios)</button>
                    </div>
                </div>

                <div id="screen-quiz" class="hidden">
                    <div class="hud">
                        <span>MÓDULO ACTIVO | NODO: <span id="current-q">1</span>/<span id="total-q"></span></span>
                        <span id="progress-bar" class="amber-text">ESTADO: [ ESTABLE ]</span>
                    </div>
                    
                    <h3 id="question-text" style="min-height: 40px;"></h3>
                    <div id="math-container" class="math-container" style="margin-bottom: 20px; font-weight: bold; color: var(--text-white);"></div>
                    <div class="options-grid" id="options-container"></div>

                    <div id="feedback-area">
                        <h3 id="feedback-title" style="margin-top:0;"></h3>
                        <p id="feedback-text" style="margin:0; font-family: 'Consolas', monospace;"></p>
                    </div>

                    <button class="btn-industrial" id="btn-next" onclick="nextQuestion()">>> AVANZAR AL SIGUIENTE NODO</button>
                    <button class="btn-industrial btn-abort" onclick="returnToMenu()">[X] ABORTAR Y VOLVER AL MENÚ</button>
                </div>

                <div id="screen-result" class="hidden">
                    <h1 style="color:var(--text-white)">> DIAGNÓSTICO DEL MÓDULO</h1>
                    <p id="result-text" style="font-size: 1.1rem; line-height: 2; font-weight: bold;"></p>
                    <br>
                    <button class="btn-industrial" onclick="returnToMenu()" style="text-align:center; margin-top: 10px; border-color:var(--text-main);">>> VOLVER AL MENÚ PRINCIPAL</button>
                </div>
            </div>

            <div class="creator-signature">
                MÓDULO DE EVALUACIÓN CREADO Y DISEÑADO POR: FACUNDO BARROJO
                <span class="creator-contact">LÍNEA DE SOPORTE Y TUTORÍAS: +54 9 381 5690147</span>
            </div>

        </div>
    </div>

<script>
    // --- 1. MOTOR DE AUDIO ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx;
    let synth = window.speechSynthesis;

    function initAudio() {
        if (!audioCtx) audioCtx = new AudioContext();
        if (audioCtx.state === 'suspended') audioCtx.resume();
    }

    function playSound(type) {
        if (!audioCtx) return;
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        const now = audioCtx.currentTime;

        if (type === 'tick') {
            osc.type = 'square'; osc.frequency.setValueAtTime(800, now);
            gain.gain.setValueAtTime(0.015, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.02);
            osc.start(); osc.stop(now + 0.02);
        } else if (type === 'correct') {
            osc.type = 'sine'; osc.frequency.setValueAtTime(800, now);
            osc.frequency.linearRampToValueAtTime(1400, now + 0.1);
            gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.3);
            osc.start(); osc.stop(now + 0.3);
        } else if (type === 'wrong') {
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(300, now);
            osc.frequency.exponentialRampToValueAtTime(100, now + 0.3);
            gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
            osc.start(); osc.stop(now + 0.3);
        } else if (type === 'boot') {
            osc.type = 'sine'; osc.frequency.setValueAtTime(400, now);
            osc.frequency.linearRampToValueAtTime(800, now + 1);
            gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0, now + 1);
            osc.start(); osc.stop(now + 1);
        }
    }

    let isTyping = false;
    let typeWriterInterval = null;

    // --- 2. VOZ FEMENINA Y SINCRONIZACIÓN ---
    function eveSpeakAndType(textToSpeak, textToType, htmlElement, callback) {
        if(synth.speaking) synth.cancel();
        clearInterval(typeWriterInterval);
        
        let utterance = new SpeechSynthesisUtterance(textToSpeak);
        let voices = synth.getVoices();
        
        // Buscar voz FEMENINA (Sabina, Paulina, Monica, Google, Female)
        let voice = voices.find(v => v.lang.startsWith('es') && (v.name.includes('Female') || v.name.includes('Monica') || v.name.includes('Paulina') || v.name.includes('Sabina') || v.name.includes('Elena') || v.name.includes('Google')));
        if(!voice) voice = voices.find(v => v.lang.startsWith('es')); 
        
        if(voice) utterance.voice = voice;
        utterance.pitch = 1.3; // Tono femenino/agudo (EVA)
        utterance.rate = 1.1; // Velocidad fluida
        
        const robotImg = document.getElementById('eve-container');
        const robotStatus = document.getElementById('eve-status');
        
        // Cálculo de sincronización
        let estimatedTimeMs = (textToSpeak.length / 14) * 1000 / utterance.rate;
        let typingSpeed = estimatedTimeMs / textToType.length;
        if(typingSpeed < 20) typingSpeed = 20; 
        if(typingSpeed > 70) typingSpeed = 70;

        isTyping = true;
        let charIndex = 0;
        let currentString = "";
        
        typeWriterInterval = setInterval(() => {
            if (charIndex < textToType.length) {
                let char = textToType.charAt(charIndex);
                if (char === '\n') currentString += "<br>"; else currentString += char;
                htmlElement.innerHTML = currentString + '<span class="cursor"></span>';
                if (charIndex % 3 === 0 && char !== ' ' && char !== '\n') playSound('tick');
                charIndex++;
            } else {
                clearInterval(typeWriterInterval);
            }
        }, typingSpeed);

        utterance.onstart = function() {
            robotImg.classList.add('speaking');
            robotStatus.innerText = "[ COMUNICANDO... ]";
            robotStatus.classList.add('speaking');
        };
        
        utterance.onend = function() {
            clearInterval(typeWriterInterval);
            htmlElement.innerHTML = textToType.replace(/\n/g, "<br>");
            isTyping = false;
            
            robotImg.classList.remove('speaking');
            robotStatus.innerText = "[ EN ESPERA ]";
            robotStatus.classList.remove('speaking');
            if(callback) callback();
        };

        synth.speak(utterance);
    }

    // Tipeo silencioso para las preguntas (EVA no lee esto)
    function typeTextSilent(element, text, speed, callback) {
        clearInterval(typeWriterInterval);
        isTyping = true;
        let i = 0; let currentString = "";
        typeWriterInterval = setInterval(() => {
            if (i < text.length) {
                let char = text.charAt(i);
                if (char === '\n') currentString += "<br>"; else currentString += char;
                element.innerHTML = currentString + '<span class="cursor"></span>';
                if (i % 2 === 0 && char !== ' ') playSound('tick');
                i++;
            } else {
                clearInterval(typeWriterInterval);
                element.innerHTML = currentString; 
                isTyping = false;
                if(callback) callback();
            }
        }, speed);
    }

    if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = () => { synth.getVoices(); };
    }

    // --- BASE DE DATOS ---
    const quizData = {
        conceptos: [
            { q: "01. ¿Cuál es la diferencia entre 'equivocación' e 'incertidumbre'?", math: "", options: [ { txt: "Son lo mismo.", correct: false }, { txt: "Equivocación es error humano; incertidumbre es limitación del instrumento.", correct: true }, { txt: "Incertidumbre solo ocurre en digitales.", correct: false } ], feedback: "Exacto. Un humano puede evitar equivocarse, pero nunca la incertidumbre natural de la escala." },
            { q: "02. En el número 0,0450 kg, ¿cuántas cifras significativas hay?", math: "", options: [ { txt: "5 cifras.", correct: false }, { txt: "2 cifras.", correct: false }, { txt: "3 cifras (4, 5 y el 0 final).", correct: true } ], feedback: "Correcto. Los ceros a la izquierda ubican la coma. El cero a la derecha SÍ garantiza precisión." },
            { q: "03. Con una regla escolar común, ¿cuál es el error instrumental asumido?", math: "", options: [ { txt: "± 1 mm (ó 0,1 cm).", correct: true }, { txt: "± 1 cm.", correct: false }, { txt: "Depende del pulso.", correct: false } ], feedback: "El error instrumental se asume como la mínima división de la escala del aparato." },
            { q: "04. Da un ejemplo de Error 'Sistemático' y 'Accidental'.", math: "", options: [ { txt: "Sistemático: Balanza mal calibrada. Accidental: Corriente de aire.", correct: true }, { txt: "Sistemático es humano, Accidental de máquina.", correct: false }, { txt: "Ambos son impredecibles.", correct: false } ], feedback: "El sistemático obedece a un patrón. El accidental es el azar del universo." },
            { q: "05. ¿Qué indicador evalúa si la medición es de buena 'calidad'?", math: "", options: [ { txt: "Error Absoluto.", correct: false }, { txt: "Error Relativo.", correct: true }, { txt: "Ninguno.", correct: false } ], feedback: "El Error Relativo compara cuánto te equivocaste respecto al tamaño total." },
            { q: "06. ¿Cuál es el choque de reglas entre Suma y Multiplicación?", math: "", options: [ { txt: "No hay reglas.", correct: false }, { txt: "En sumas domina la posición decimal; en multiplicación la cantidad de cifras.", correct: true }, { txt: "Multiplicar exige más decimales.", correct: false } ], feedback: "Al sumar alineamos comas. Al multiplicar, arrastramos la calidad de las cifras." },
            { q: "07. El Jefe y el Subordinado: ¿Cómo se redondea (Valor ± Error)?", math: "", options: [ { txt: "Ambos a 2 decimales.", correct: false }, { txt: "El Error a 1 cifra significativa. El Valor Central acata esa posición decimal.", correct: true }, { txt: "El Valor Central nunca cambia.", correct: false } ], feedback: "¡Regla de oro! El Error es el 'Jefe' que dictamina el límite del valor central." },
            { q: "08. ¿Por qué es distinto equivocarse 1 cm en un clip vs 1 cm en un puente?", math: "", options: [ { txt: "El puente tiene un Error Relativo excelente. El clip un error pésimo.", correct: true }, { txt: "Son igual de malos (Error Abs = 1cm).", correct: false }, { txt: "El clip es más preciso.", correct: false } ], feedback: "La física es proporción. 1 cm en 1000 metros es solo 0,001% de error." },
            { q: "09. ¿Cómo se calcula el error total del perímetro de un triángulo?", math: "", options: [ { txt: "Suman Errores Relativos.", correct: false }, { txt: "Promedian errores.", correct: false }, { txt: "Suman Errores Absolutos.", correct: true } ], feedback: "Para Sumas y Restas: E_total = E1 + E2 + E3." },
            { q: "10. Cronómetro ±0,01s vs Humano. ¿Por qué el error final es mayor al del cronómetro?", math: "", options: [ { txt: "Se multiplica por 5.", correct: false }, { txt: "El tiempo de reacción humano (~0,1s) predomina estadísticamente.", correct: true }, { txt: "El cronómetro siempre falla.", correct: false } ], feedback: "En tiempos manuales siempre domina el error estadístico humano por sobre la máquina." }
        ],
        ejercicios: [
            { q: "Ejercicio 1: Perímetro de escalón (Suma).", math: "\\[L_1 = (30,5 \\pm 0,1)\\text{ cm}\\] \\[L_2 = (40,2 \\pm 0,1)\\text{ cm}\\] \\[L_3 = (50,4 \\pm 0,1)\\text{ cm}\\]", options: [ { txt: "P = (121,1 ± 0,3) cm", correct: true }, { txt: "P = (121,1 ± 0,1) cm", correct: false }, { txt: "P = (121 ± 0,3) cm", correct: false } ], feedback: "Se suman los valores (121,1) y los absolutos (0,3)." },
            { q: "Ejercicio 2: Área de placa (Multiplicación).", math: "\\[L = (124,5 \\pm 0,5)\\text{ cm}\\] \\[A = (25,40 \\pm 0,02)\\text{ cm}\\]", options: [ { txt: "A = (3162,3 ± 0,52) cm²", correct: false }, { txt: "A = (3160 ± 20) cm²", correct: true }, { txt: "A = (3162 ± 15) cm²", correct: false } ], feedback: "e_total = 0,0048. Área = 3162,3. Error = 15,17 -> Redondeado a 1 cifra = 20. Valor acata: 3160." },
            { q: "Ejercicio 3: Volumen (Suma los relativos).", math: "\\[L = (30,0 \\pm 0,1)\\text{ cm}\\] \\[A = (18,5 \\pm 0,1)\\text{ cm}\\] \\[H = (12,0 \\pm 0,1)\\text{ cm}\\]", options: [ { txt: "V = (6660 ± 110) cm³", correct: true }, { txt: "V = (6660 ± 0,3) cm³", correct: false }, { txt: "V = (6660 ± 113,6) cm³", correct: false } ], feedback: "Volumen = 6660. e_total = 0,017. Error Abs = 113 -> 110. (Corte en decenas)." },
            { q: "Ejercicio 4: Tiempos (1,45 ; 1,52 ; 1,48 ; 1,43 ; 1,50). Error inst = 0,01s.", math: "", options: [ { txt: "t = (1,48 ± 0,01) s", correct: false }, { txt: "t = (7,38 ± 0,05) s", correct: false }, { txt: "t = (1,48 ± 0,05) s", correct: true } ], feedback: "Promedio = 1,48s. El error estadístico (~0,05s) domina sobre la máquina (0,01s)." },
            { q: "Ejercicio 5: La Potencia. Área de moneda ($A = \\pi \\cdot r^2$).", math: "\\[r = (1,25 \\pm 0,02)\\text{ cm}\\]", options: [ { txt: "A = (4,91 ± 0,04) cm²", correct: false }, { txt: "A = (4,9 ± 0,2) cm²", correct: true }, { txt: "A = (4,91 ± 0,16) cm²", correct: false } ], feedback: "e_r = 0,016. e_A = 2 * 0,016 = 0,032. Error Abs = 0,157 -> 0,2. Resultado: 4,9 ± 0,2." }
        ]
    };

    let currentPhase = '';
    let currentQIndex = 0;
    let score = 0;

    function toggleTheme() { document.documentElement.setAttribute('data-theme', document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'); }
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

    // --- 3. FLUJO DEL PROGRAMA ---
    function bootSystem() {
        document.getElementById('init-overlay').style.display = 'none';
        initAudio();
        
        const bootTextType = `> INICIALIZANDO KERNEL SCADA... [OK]\n> VERIFICANDO RELES... [OK]\n> SINCRONISMO... [ESTABLE: 50.00 Hz]\n> ASISTENTE IA EVA... [ONLINE]\n\n>> USUARIO: MAJO\n> ESTADO: AGUARDANDO SELECCIÓN DE MÓDULO...`;
        const bootTextSpeak = "Hola Majo. Soy Eva, tu asistente virtual. He iniciado el sistema y los módulos están estables. Por favor, selecciona la evaluación que deseas realizar hoy.";
        
        eveSpeakAndType(bootTextSpeak, bootTextType, document.getElementById('menu-title'), () => {
            document.getElementById('menu-options').classList.remove('hidden');
        });
    }

    function startModule(moduleName) {
        playSound('boot');
        currentPhase = moduleName;
        currentQIndex = 0; score = 0;
        
        document.getElementById('screen-menu').classList.add('hidden');
        document.getElementById('screen-result').classList.add('hidden');
        document.getElementById('screen-quiz').classList.remove('hidden');
        
        let speechMsg = moduleName === 'conceptos' ? "Iniciando análisis conceptual. Lee atentamente cada afirmación en el panel central." : "Iniciando cálculos. Prepara papel, lápiz y calculadora.";
        let typeMsg = `> INICIANDO MÓDULO: ${moduleName.toUpperCase()}...\n> PREPARANDO INTERFAZ DE EXAMEN...`;

        // EVA anuncia el módulo, luego empieza el examen mudo
        eveSpeakAndType(speechMsg, typeMsg, document.getElementById('question-text'), () => {
            loadQuestion();
        });
    }

    function loadQuestion() {
        let qList = quizData[currentPhase];
        if (currentQIndex >= qList.length) { endModule(); return; }

        let qData = qList[currentQIndex];
        
        document.getElementById('current-q').innerText = currentQIndex + 1;
        document.getElementById('total-q').innerText = qList.length;
        document.getElementById('progress-bar').innerText = "ESTADO: [ ESPERANDO INPUT ]";
        document.getElementById('progress-bar').className = "amber-text";
        
        document.getElementById('options-container').innerHTML = "";
        document.getElementById('math-container').innerHTML = "";
        document.getElementById('feedback-area').style.display = "none";
        document.getElementById('btn-next').style.display = "none";

        // Tipeo sin voz para no cansar al alumno
        typeTextSilent(document.getElementById('question-text'), "> " + qData.q, 25, () => {
            if(qData.math !== "") document.getElementById('math-container').innerHTML = qData.math;
            const letters = ["A", "B", "C"]; let optionsHtml = "";
            qData.options.forEach((opt, idx) => {
                let correctClass = opt.correct ? "is-correct-option" : "";
                optionsHtml += `<button class="option-btn ${correctClass}" onclick="checkAnswer(this, ${opt.correct})">
                                    <span class="option-letter">[${letters[idx]}]</span>
                                    <span>${opt.txt}</span>
                                </button>`;
            });
            document.getElementById('options-container').innerHTML = optionsHtml;
            MathJax.typesetPromise();
        });
    }

    // --- 4. LÓGICA DE ANIMACIÓN DE EVA (Acierto/Fallo) ---
    function checkAnswer(btn, isCorrect) {
        if (isTyping || btn.classList.contains("disabled")) return;
        document.querySelectorAll(".option-btn").forEach(b => b.classList.add("disabled"));

        const feedback = quizData[currentPhase][currentQIndex].feedback;
        const feedbackArea = document.getElementById('feedback-area');
        const feedbackTitle = document.getElementById('feedback-title');
        const feedbackText = document.getElementById('feedback-text');
        const progBar = document.getElementById('progress-bar');
        const eveContainer = document.getElementById('eve-container');

        // Limpiar animaciones previas
        eveContainer.classList.remove('state-correct', 'state-wrong');
        void eveContainer.offsetWidth; // Trigger reflow para reiniciar animación CSS

        if (isCorrect) {
            playSound('correct'); 
            btn.classList.add("correct");
            
            // EVA Asiente y ojos verdes
            eveContainer.classList.add('state-correct');
            setTimeout(() => eveContainer.classList.remove('state-correct'), 1500);

            feedbackTitle.innerText = "[ VALIDACIÓN EXITOSA ]"; feedbackTitle.style.color = "var(--accent-green)";
            feedbackArea.style.borderColor = "var(--accent-green)"; feedbackArea.style.borderLeftColor = "var(--accent-green)";
            progBar.innerText = "ESTADO: [ SINCRONIZADO ]"; progBar.style.color = "var(--accent-green)";
            score++;
        } else {
            playSound('wrong'); 
            btn.classList.add("wrong");
            const correctBtn = document.querySelector(".is-correct-option");
            if(correctBtn) correctBtn.classList.add("correct");

            // EVA Niega y ojos rojos
            eveContainer.classList.add('state-wrong');
            setTimeout(() => eveContainer.classList.remove('state-wrong'), 1500);

            feedbackTitle.innerText = "[ ERROR EN CÁLCULO ]"; feedbackTitle.style.color = "var(--accent-crimson)";
            feedbackArea.style.borderColor = "var(--accent-crimson)"; feedbackArea.style.borderLeftColor = "var(--accent-crimson)";
            progBar.innerText = "ESTADO: [ FALLA CRÍTICA ]"; progBar.style.color = "var(--accent-crimson)";

            const panel = document.getElementById('terminal-container');
            panel.style.boxShadow = "0 0 40px rgba(255, 23, 68, 0.6)";
            setTimeout(() => panel.style.boxShadow = "0 10px 30px rgba(0,0,0,0.5)", 200);
        }

        feedbackText.innerHTML = feedback;
        feedbackArea.style.display = "block";
        document.getElementById('btn-next').style.display = "block";
        MathJax.typesetPromise();
    }

    function nextQuestion() { currentQIndex++; loadQuestion(); }

    function endModule() {
        document.getElementById('screen-quiz').classList.add('hidden');
        document.getElementById('screen-result').classList.remove('hidden');
        
        let totalQ = quizData[currentPhase].length;
        let percentage = (score / totalQ);
        let passed = percentage >= 0.5; 
        
        let moduleNameDisplay = currentPhase === 'conceptos' ? 'CONCEPTUAL' : 'CÁLCULO';
        let typeMsg = `=======================================\n> MÓDULO EVALUADO : ${moduleNameDisplay}\n> ACIERTOS        : ${score} / ${totalQ}\n=======================================\n\n`;

        let speechMsg = "";

        if (passed) {
            typeMsg += `[ STATUS: APROBADO ]\nExcelente trabajo Majo. Superaste el 50% requerido.`;
            document.getElementById('result-text').className = 'success-text';
            speechMsg = `Módulo completado. Aprobaste con éxito, lograste ${score} aciertos. Muy buen trabajo, Majo.`;
        } else {
            typeMsg += `[ STATUS: DESAPROBADO ]\nFalla en certificación. No alcanzaste el 50%.\nDebes revisar la DB_APUNTES.`;
            document.getElementById('result-text').className = 'crimson-text';
            speechMsg = `Módulo completado. Lamentablemente no alcanzaste el 50 por ciento mínimo. Es necesario que repases los apuntes del sistema e intentes de nuevo.`;
        }
            
        eveSpeakAndType(speechMsg, typeMsg, document.getElementById('result-text'));
    }

    function returnToMenu() {
        synth.cancel(); clearInterval(typeWriterInterval); playSound('boot');
        document.getElementById('screen-quiz').classList.add('hidden');
        document.getElementById('screen-result').classList.add('hidden');
        document.getElementById('screen-menu').classList.remove('hidden');
        
        eveSpeakAndType("Sistema en espera. Selecciona tu siguiente paso.", ">> USUARIO: MAJO\n> ESTADO: AGUARDANDO SELECCIÓN...", document.getElementById('menu-title'));
    }

    let eggClicks = 0;
    function triggerEasterEgg() {
        eggClicks++;
        if (eggClicks === 3) {
            playSound('correct');
            eveSpeakAndType("Mensaje clasificado de Facundo. Éxitos en tu parcial Majo, vas a rendir espectacular.", "ACCESO CLASIFICADO", document.getElementById('result-text'), () => {
                 alert("¡Muchos éxitos en tu examen, Majo!\nVas a aprobar sin ningún problema, confía en lo que aprendiste.\n\nAtte: Tu tutor, Facundo.");
            });
            eggClicks = 0;
        }
        setTimeout(() => { if(eggClicks > 0 && eggClicks < 3) eggClicks = 0; }, 1500);
    }
</script>
</body>
</html>